library(readr)

# load everything
dif_eta_table_001 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_001.csv")
dif_eta_table_001 <- data.frame(run=001,dif_eta_table_001)
dif_eta_table_002 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_002.csv")
dif_eta_table_002 <- data.frame(run=002,dif_eta_table_002)
dif_eta_table_003 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_003.csv")
dif_eta_table_003 <- data.frame(run=003,dif_eta_table_003)
dif_eta_table_004 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_004.csv")
dif_eta_table_004 <- data.frame(run=004,dif_eta_table_004)
dif_eta_table_005 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_005.csv")
dif_eta_table_005 <- data.frame(run=005,dif_eta_table_005)
dif_eta_table_006 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_006.csv")
dif_eta_table_006 <- data.frame(run=006,dif_eta_table_006)
dif_eta_table_007 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_007.csv")
dif_eta_table_007 <- data.frame(run=007,dif_eta_table_007)
dif_eta_table_008 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_008.csv")
dif_eta_table_008 <- data.frame(run=008,dif_eta_table_008)
dif_eta_table_101 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_101.csv")
dif_eta_table_101 <- data.frame(run=101,dif_eta_table_101)
dif_eta_table_102 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_102.csv")
dif_eta_table_102 <- data.frame(run=102,dif_eta_table_102)
dif_eta_table_201 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_201.csv")
dif_eta_table_201 <- data.frame(run=201,dif_eta_table_201)
dif_eta_table_202 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_202.csv")
dif_eta_table_202 <- data.frame(run=202,dif_eta_table_202)
dif_eta_table_203 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_203.csv")
dif_eta_table_203 <- data.frame(run=203,dif_eta_table_203)
dif_eta_table_204 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_204.csv")
dif_eta_table_204 <- data.frame(run=204,dif_eta_table_204)
dif_eta_table_205 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_205.csv")
dif_eta_table_205 <- data.frame(run=205,dif_eta_table_205)
dif_eta_table_206 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_206.csv")
dif_eta_table_206 <- data.frame(run=206,dif_eta_table_206)
dif_eta_table_207 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_207.csv")
dif_eta_table_207 <- data.frame(run=207,dif_eta_table_207)
dif_eta_table_208 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_208.csv")
dif_eta_table_208 <- data.frame(run=208,dif_eta_table_208)
dif_eta_table_301 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_301.csv")
dif_eta_table_301 <- data.frame(run=301,dif_eta_table_301)
dif_eta_table_302 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_302.csv")
dif_eta_table_302 <- data.frame(run=302,dif_eta_table_302)
dif_eta_table_401 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_401.csv")
dif_eta_table_401 <- data.frame(run=401,dif_eta_table_401)
dif_eta_table_402 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_402.csv")
dif_eta_table_402 <- data.frame(run=402,dif_eta_table_402)
dif_eta_table_403 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_403.csv")
dif_eta_table_403 <- data.frame(run=403,dif_eta_table_403)
dif_eta_table_404 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_404.csv")
dif_eta_table_404 <- data.frame(run=404,dif_eta_table_404)
dif_eta_table_405 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_405.csv")
dif_eta_table_405 <- data.frame(run=405,dif_eta_table_405)
dif_eta_table_406 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_406.csv")
dif_eta_table_406 <- data.frame(run=406,dif_eta_table_406)
dif_eta_table_407 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_407.csv")
dif_eta_table_407 <- data.frame(run=407,dif_eta_table_407)
dif_eta_table_408 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_408.csv")
dif_eta_table_408 <- data.frame(run=408,dif_eta_table_408)
dif_eta_table_501 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_501.csv")
dif_eta_table_501 <- data.frame(run=501,dif_eta_table_501)
dif_eta_table_502 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_502.csv")
dif_eta_table_502 <- data.frame(run=502,dif_eta_table_502)
dif_eta_table_503 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_503.csv")
dif_eta_table_503 <- data.frame(run=503,dif_eta_table_503)
dif_eta_table_504 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_504.csv")
dif_eta_table_504 <- data.frame(run=504,dif_eta_table_504)
dif_eta_table_511 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_511.csv")
dif_eta_table_511 <- data.frame(run=511,dif_eta_table_511)
dif_eta_table_512 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_512.csv")
dif_eta_table_512 <- data.frame(run=512,dif_eta_table_512)
dif_eta_table_513 <- read_csv("~/posologyr-pharmaceutics/posologyr-output/dif_eta_table_513.csv")
dif_eta_table_513 <- data.frame(run=513,dif_eta_table_513)

# bind everything
dif_eta_all <- rbind(dif_eta_table_001,
                     dif_eta_table_002,
                     dif_eta_table_003,
                     dif_eta_table_004,
                     dif_eta_table_005,
                     dif_eta_table_006,
                     dif_eta_table_007,
                     dif_eta_table_008,
                     dif_eta_table_101,
                     dif_eta_table_102,
                     dif_eta_table_201,
                     dif_eta_table_202,
                     dif_eta_table_203,
                     dif_eta_table_204,
                     dif_eta_table_205,
                     dif_eta_table_206,
                     dif_eta_table_207,
                     dif_eta_table_208,
                     dif_eta_table_301,
                     dif_eta_table_302,
                     dif_eta_table_401,
                     dif_eta_table_402,
                     dif_eta_table_403,
                     dif_eta_table_404,
                     dif_eta_table_405,
                     dif_eta_table_406,
                     dif_eta_table_407,
                     dif_eta_table_408,
                     dif_eta_table_501,
                     dif_eta_table_502,
                     dif_eta_table_503,
                     dif_eta_table_504,
                     dif_eta_table_511,
                     dif_eta_table_512,
                     dif_eta_table_513)

all_dif <- data.table::data.table(id=rep(1:4000,35),
                                  dif_eta_all,
                                  sampling=rep(1:4,35000))

# write it down
write_csv(all_dif,
          "~/posologyr-pharmaceutics/posologyr-output/all_diff_final.csv")

# plot something ---------------------------------------------------------------
dt_dif_plot <- data.table::data.table("run"=sort(rep(unique(all_dif$run),3)),
                                      "level"=c(1,2,3),
                                      "prop"=0)

#discordant
dt_dif_plot <- merge(dt_dif_plot,all_dif[max_dif>95e-3][,.N,by=run],
                     by="run",all.x=TRUE)
#acceptable
dt_dif_plot <- merge(dt_dif_plot,all_dif[max_dif>1e-3 &
                                           max_dif<=95e-3][,.N,by=run],
                     by="run",all.x=TRUE)
#excellent
dt_dif_plot <- merge(dt_dif_plot,all_dif[max_dif<=1e-3][,.N,by=run],
                     by="run",all.x=TRUE)

#set props
dt_dif_plot[level==1,prop:=(N/40)] #excellent
dt_dif_plot[level==2,prop:=(N.x/40)] #discordant
dt_dif_plot[is.na(prop)]$prop <- 0     #no discordant estimate, prop == 0
dt_dif_plot[level==3,prop:=(N.y/40)] #acceptable
dt_dif_plot[is.na(prop)]$prop <- 0     #no acceptable estimate, prop == 0
dt_dif_plot[,run:=as.factor(run)]
dt_dif_plot[,prop:=as.numeric(prop)]
dt_dif_plot[,level:=as.factor(level)]

#sort by less discordances
setorder(dt_dif_plot,cols="N.x")
dt_dif_plot[,sort_by_perf:=sort(rep(1:35,3))]
dt_dif_plot[,sort_by_perf:=as.factor(sort_by_perf)]
levels(dt_dif_plot$sort_by_perf) <- unique(dt_dif_plot$run)

#splt data.table
dt1 <- dt_dif_plot[level!=2] # not discordant
dt2 <- dt_dif_plot[level==2] # discordant

#Plot
library(ggplot2)

ggplot() +
  geom_bar(data=dt2,
           aes(x = run, y=-prop, fill = level,
               ),
               position="stack", stat="identity") +
  geom_bar(data=dt1,
           aes(x = run, y=prop, fill = level,
               ),
               position="stack", stat="identity") +
  ylim(-20,100) +
  #scale_x_discrete(limits = rev(levels(dt1$run))) +
  scale_x_discrete(limits = rev(levels(dt2$sort_by_perf))) +
  geom_hline(yintercept = 0, color =c("black"))+
  theme_light() +
  coord_flip() +
  #guides(fill=guide_legend(title="",reverse=FALSE)) +
  scale_fill_brewer(palette="Paired", name="",labels=c("Excellent",
                                                      "Discordant",
                                                      "Acceptable"),
                    direction=-1) +
  labs(#title=expression(bold("Performance of MAP estimation")),
       y="Percentages of acceptable and excellent estimations",x="")
